<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>花火アニメーション（かむろ追加版）</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
  <style>
    /* ページの余白をなくす */
    body {
      padding: 0;
      margin: 0;
      overflow: hidden; /* スクロールバーを非表示にする */
    }
  </style>
</head>
<body>
  <script>
    // ==================================================================
    // ★★★ パラメータ調整エリア ★★★
    // ==================================================================

    // --- 全体に関する設定 ---
    const NEW_FIREWORK_PROBABILITY = 0.03; 
    const CLICK_FIREWORK_COUNT = 1;      

    // --- 打ち上げに関する設定 ---
    const LAUNCH_SPEED_MIN = -11; 
    const LAUNCH_SPEED_MAX = -6;  
    const GRAVITY = 0.1;          

    // --- 爆発の見た目に関する設定 ---
    const PARTICLE_COUNT_MIN = 80;  
    const PARTICLE_COUNT_MAX = 200; 
    const OUTER_RING_COUNT = 15;    
    const COLOR_CHANGE_THRESHOLD = 160;

    // --- 爆発の動きに関する設定 ---
    const EXPLOSION_SPEED_MIN = 0.5; 
    const EXPLOSION_SPEED_MAX = 10;  
    const PARTICLE_DRAG = 0.96;      
    const PARTICLE_FADE_RATE = 3.5;
    
    // ★★★ 変更点：「かむろ」専用のパラメータを追加 ★★★
    const KAMURO_GRAVITY = 0.03; // かむろの粒子にかかる特別な重力（小さいほどゆっくり落ちる）
    const KAMURO_FADE_RATE = 1.0;  // かむろの粒子の消える速さ（小さいほど長く残る）
    const KAMURO_GLITTER_PROBABILITY = 0; // かむろの粒子がキラキラ光る粒を出す確率
    const KAMURO_GLITTER_FADE_RATE = 15;  // キラキラ光る粒の消える速さ（大きいほどすぐ消える）


    // ==================================================================


    // --- グローバル変数 ---
    let fireworks = [];
    let gravity;
    // ★★★ 変更点：かむろ専用の重力ベクトルを追加 ★★★
    let kamuroGravity;

    function setup() {
      createCanvas(windowWidth, windowHeight);
      gravity = createVector(0, GRAVITY);
      kamuroGravity = createVector(0, KAMURO_GRAVITY); // かむろ専用の重力ベクトルを初期化
      stroke(255);
      strokeWeight(4);
      colorMode(HSB);
    }

    function draw() {
      colorMode(RGB);
      background(0, 0, 0, 25);
      
      if (random(1) < NEW_FIREWORK_PROBABILITY) {
        fireworks.push(new Firework());
      }

      for (let i = fireworks.length - 1; i >= 0; i--) {
        fireworks[i].update();
        fireworks[i].show();
        if (fireworks[i].done()) {
          fireworks.splice(i, 1);
        }
      }
    }
    
    function mousePressed() {
      for (let i = 0; i < CLICK_FIREWORK_COUNT; i++) {
        fireworks.push(new Firework(mouseX));
      }
    }

    // ===== パーティクル（粒子）クラス =====
    class Particle {
      constructor(x, y, isFirework, options = {}) {
        this.pos = createVector(x, y);
        this.prevPos = createVector(x, y); 
        this.isFirework = isFirework;
        this.lifespan = 255;
        this.acc = createVector(0, 0);

        this.hu = options.hu || 0;
        this.hu2 = options.hu2 || this.hu;
        this.type = options.type || 'point';
        this.effect = options.effect || 'normal';

        if (isFirework) {
          this.vel = createVector(0, random(LAUNCH_SPEED_MIN, LAUNCH_SPEED_MAX));
        } else {
          this.vel = options.velocity;
        }
      }

      applyForce(force) {
        this.acc.add(force);
      }

      update() {
        this.prevPos.set(this.pos);
        if (!this.isFirework) {
          this.vel.mult(PARTICLE_DRAG);
          
          // ★★★ 変更点：エフェクトタイプに応じて寿命の減り方を変える ★★★
          if (this.effect === 'kamuro') {
            this.lifespan -= KAMURO_FADE_RATE;
          } else if (this.effect === 'glitter') {
            this.lifespan -= KAMURO_GLITTER_FADE_RATE;
          } else {
            this.lifespan -= PARTICLE_FADE_RATE;
          }
        }
        this.vel.add(this.acc);
        this.pos.add(this.vel);
        this.acc.mult(0);
      }

      done() {
        return this.lifespan < 0;
      }

      show() {
        colorMode(HSB);
        
        if (!this.isFirework) {
          // ★★★ 変更点：エフェクトタイプに応じて見た目を変える ★★★
          if (this.effect === 'glitter') {
            strokeWeight(1); // キラキラ光る粒は小さく
          } else {
            strokeWeight(2);
          }

          if (this.effect === 'colorChange') {
            let finalColor;
            if (this.lifespan > COLOR_CHANGE_THRESHOLD) {
              finalColor = color(this.hu, 255, 255);
            } else {
              const fromColor = color(this.hu, 255, 255);
              const toColor = color(this.hu2, 255, 255);
              const amt = map(this.lifespan, COLOR_CHANGE_THRESHOLD, 0, 0, 1);
              finalColor = lerpColor(fromColor, toColor, amt);
            }
            stroke(finalColor, this.lifespan);
          } else {
            stroke(this.hu, 255, 255, this.lifespan);
          }

          if (this.type === 'line' && this.effect !== 'glitter') {
            line(this.pos.x, this.pos.y, this.prevPos.x, this.prevPos.y);
          } else {
            point(this.pos.x, this.pos.y);
          }
        } else {
          strokeWeight(4);
          stroke(this.hu, 255, 255);
          point(this.pos.x, this.pos.y);
        }
      }
    }

    // ===== 花火クラス =====
    class Firework {
      constructor(x) {
        // ★★★ 変更点：kamuroをエフェクトリストに追加 ★★★
        const effects = ['normal', 'colorChange', 'bicolor', 'kamuro', 'kamuro']; // かむろの出現率を少し上げる
        this.effect = random(effects);

        if (this.effect === 'kamuro') {
          this.hu = random(40, 60); // かむろの色を金色/黄色系に
          this.type = 'point'; // かむろの形状を点に固定
        } else {
          this.hu = random(360);
          this.type = random(1) < 0.5 ? 'point' : 'line';
        }
        
        const startX = x || random(200, width - 200);
        this.firework = new Particle(startX, height, true, { hu: this.hu });
        this.exploded = false;
        this.particles = [];
        this.particleCount = random(PARTICLE_COUNT_MIN, PARTICLE_COUNT_MAX);

        if (this.effect === 'colorChange') {
          this.hu2 = random(360); 
        } else if (this.effect === 'bicolor') {
          this.hu2 = (this.hu + 180) % 360; 
        }
      }

      done() { return this.exploded && this.particles.length === 0; }

      update() {
        if (!this.exploded) {
          this.firework.applyForce(gravity);
          this.firework.update();
          if (this.firework.vel.y >= 0) {
            this.exploded = true;
            this.explode();
          }
        } else {
          for (let i = this.particles.length - 1; i >= 0; i--) {
            const p = this.particles[i];
            
            // ★★★ 変更点：kamuroエフェクトに特別な処理を追加 ★★★
            if (p.effect === 'kamuro' && !p.isFirework) {
              // 1. 専用の弱い重力をかける
              p.applyForce(kamuroGravity);

              // 2. 確率でキラキラ光る粒を生成する
              if (random(1) < KAMURO_GLITTER_PROBABILITY) {
                const glitterOptions = {
                  velocity: p5.Vector.random2D().mult(0.5), // その場に留まるような微弱な速度
                  type: 'point',
                  effect: 'glitter', // キラキラ光る粒専用のエフェクト
                  hu: p.hu
                };
                // 新しいキラキラ粒子を花火の粒子リストに追加
                this.particles.push(new Particle(p.pos.x, p.pos.y, false, glitterOptions));
              }
            }
            
            p.update();
            if (p.done()) {
              this.particles.splice(i, 1);
            }
          }
        }
      }

      explode() {
        let maxRandomSpeed = 0;
        
        let explosionSpeed = (this.effect === 'kamuro') ? EXPLOSION_SPEED_MAX / 2 : EXPLOSION_SPEED_MAX;

        for (let i = 0; i < this.particleCount; i++) {
          const vel = p5.Vector.random2D();
          let speed = random(EXPLOSION_SPEED_MIN, explosionSpeed);
          if (speed > maxRandomSpeed) maxRandomSpeed = speed;
          vel.mult(speed);

          let particleOptions = {
            velocity: vel, type: this.type, effect: this.effect,
            hu: this.hu, hu2: this.hu2
          };
          if (this.effect === 'bicolor') {
            particleOptions.hu = random(1) < 0.5 ? this.hu : this.hu2;
          }
          this.particles.push(new Particle(this.firework.pos.x, this.firework.pos.y, false, particleOptions));
        }
        
        // かむろの時は輪郭用の火花は出さない
        if (this.effect !== 'kamuro') {
          for (let i = 0; i < OUTER_RING_COUNT; i++) {
            const angle = i * (TWO_PI / OUTER_RING_COUNT);
            const velocity = p5.Vector.fromAngle(angle).mult(maxRandomSpeed);
            let particleOptions = {
              velocity: velocity, type: this.type, effect: this.effect,
              hu: this.hu, hu2: this.hu2
            };
            if (this.effect === 'bicolor') {
              particleOptions.hu = random(1) < 0.5 ? this.hu : this.hu2;
            }
            this.particles.push(new Particle(this.firework.pos.x, this.firework.pos.y, false, particleOptions));
          }
        }
      }

      show() {
        if (!this.exploded) {
          this.firework.show();
        } else {
          for (let p of this.particles) p.show();
        }
      }
    }
  </script>
</body>
</html>